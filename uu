<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Machines</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/locale/fr.min.js"></script>

    <style>
        body {
            padding-bottom: 50px;
            background-color: #f8f9fa;
        }
        .navbar {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: none;
        }
        .table-responsive {
            margin-top: 20px;
        }
        #reader {
            min-height: 300px;
            border: 2px dashed #ccc;
            margin-bottom: 15px;
            background: #f8f9fa;
        }
        .qr-code-img {
            max-width: 100px;
            height: auto;
            cursor: pointer;
        }
        .qr-modal-img {
            max-width: 100%;
            height: auto;
        }
        .hidden {
            display: none;
        }
        .alert {
            transition: opacity 0.5s ease-out;
        }
        .view {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .cvi-expired {
            background-color: #ffdddd !important;
        }
        .cvi-soon {
            background-color: #fff3cd !important;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.5rem;
        }
        .unit-card {
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            position: relative;
        }
        .unit-card .badge {
            position: absolute;
            top: 5px;
            right: 5px;
        }
        .search-container {
            margin-bottom: 20px;
        }
        .stats-card {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#" onclick="showView('home')">
                <i class="bi bi-pc-display-horizontal me-2"></i>
                Gestion Machines
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showView('add-machine')"><i class="bi bi-plus-circle"></i> Ajouter</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showView('list-machines')"><i class="bi bi-list-ul"></i> Liste</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showView('scan')"><i class="bi bi-upc-scan"></i> Scanner</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showView('cvi')"><i class="bi bi-calendar-check"></i> CVI</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showView('export')"><i class="bi bi-cloud-arrow-down"></i> Sauvegarde</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showView('stats')"><i class="bi bi-graph-up"></i> Stats</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div id="alert-placeholder"></div>

        <!-- Vue Accueil -->
        <div id="home-view" class="view">
            <h2><i class="bi bi-house-door"></i> Tableau de bord</h2>
            <div class="row mt-4">
                <div class="col-md-4">
                    <div class="card bg-primary text-white stats-card">
                        <h3><i class="bi bi-pc-display-horizontal"></i></h3>
                        <h4 id="total-machines">0</h4>
                        <p>Machines en stock</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-warning text-dark stats-card">
                        <h3><i class="bi bi-calendar-exclamation"></i></h3>
                        <h4 id="expiring-cvi">0</h4>
                        <p>CVI bientôt expirés</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-danger text-white stats-card">
                        <h3><i class="bi bi-calendar-x"></i></h3>
                        <h4 id="expired-cvi">0</h4>
                        <p>CVI expirés</p>
                    </div>
                </div>
            </div>
            
            <div class="d-grid gap-2 mt-4">
                <button class="btn btn-primary" onclick="showView('add-machine')">
                    <i class="bi bi-plus-circle"></i> Ajouter une machine
                </button>
                <button class="btn btn-secondary" onclick="showView('list-machines')">
                    <i class="bi bi-list-ul"></i> Voir l'inventaire
                </button>
                <button class="btn btn-secondary" onclick="showView('scan')">
                    <i class="bi bi-upc-scan"></i> Scanner un produit
                </button>
            </div>
            
            <div class="card mt-4">
                <div class="card-header">
                    <h5><i class="bi bi-clock-history"></i> Dernières modifications</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Action</th>
                                    <th>Machine</th>
                                </tr>
                            </thead>
                            <tbody id="recent-activity">
                                <!-- Rempli dynamiquement -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vue Ajout Machine -->
        <div id="add-machine-view" class="view hidden">
            <h2><i class="bi bi-plus-circle"></i> Ajouter une machine</h2>
            <div class="card">
                <div class="card-body">
                    <form id="add-machine-form">
                        <div class="mb-3">
                            <label for="marque" class="form-label">Marque *</label>
                            <input type="text" class="form-control" id="marque" required>
                        </div>
                        <div class="mb-3">
                            <label for="model" class="form-label">Modèle *</label>
                            <input type="text" class="form-control" id="model" required>
                        </div>
                        <div class="mb-3">
                            <label for="quantite" class="form-label">Quantité *</label>
                            <input type="number" class="form-control" id="quantite" min="1" value="1" required>
                        </div>
                        <div class="mb-3">
                            <label for="position" class="form-label">Emplacement *</label>
                            <input type="text" class="form-control" id="position" required>
                        </div>
                        <div class="mb-3">
                            <label for="categorie" class="form-label">Catégorie</label>
                            <select class="form-select" id="categorie">
                                <option value="Ordinateur">Ordinateur</option>
                                <option value="Serveur">Serveur</option>
                                <option value="Imprimante">Imprimante</option>
                                <option value="Réseau">Équipement réseau</option>
                                <option value="Autre">Autre</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="notes" class="form-label">Notes</label>
                            <textarea class="form-control" id="notes" rows="2"></textarea>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i> Enregistrer
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="showView('home')">
                                <i class="bi bi-arrow-left"></i> Annuler
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Vue Liste Machines -->
        <div id="list-machines-view" class="view hidden">
            <h2><i class="bi bi-list-ul"></i> Inventaire des Machines</h2>
            
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="input-group">
                                <input type="text" class="form-control" id="inventory-search" placeholder="Rechercher...">
                                <button class="btn btn-outline-secondary" type="button" onclick="filterMachines()">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <select class="form-select" id="inventory-filter" onchange="filterMachines()">
                                <option value="all">Toutes les catégories</option>
                                <option value="Ordinateur">Ordinateurs</option>
                                <option value="Serveur">Serveurs</option>
                                <option value="Imprimante">Imprimantes</option>
                                <option value="Réseau">Équipements réseau</option>
                                <option value="Autre">Autre</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Marque</th>
                            <th>Modèle</th>
                            <th>Catégorie</th>
                            <th>Quantité</th>
                            <th>Emplacement</th>
                            <th>Actions</th>
                            <th>QR Code</th>
                        </tr>
                    </thead>
                    <tbody id="machines-table-body">
                        <!-- Rempli dynamiquement -->
                    </tbody>
                </table>
            </div>
            
            <div class="d-flex justify-content-between mt-3">
                <button class="btn btn-secondary" onclick="showView('home')">
                    <i class="bi bi-arrow-left"></i> Retour
                </button>
                <div class="btn-group">
                    <button class="btn btn-outline-secondary" onclick="exportInventory('pdf')">
                        <i class="bi bi-file-earmark-pdf"></i> PDF
                    </button>
                    <button class="btn btn-outline-secondary" onclick="exportInventory('excel')">
                        <i class="bi bi-file-earmark-excel"></i> Excel
                    </button>
                    <button class="btn btn-outline-secondary" onclick="exportInventory('csv')">
                        <i class="bi bi-file-earmark-text"></i> CSV
                    </button>
                </div>
            </div>
        </div>

        <!-- Vue Scan -->
        <div id="scan-view" class="view hidden">
            <h2><i class="bi bi-upc-scan"></i> Scanner un produit</h2>
            
            <div class="card">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs">
                        <li class="nav-item">
                            <a class="nav-link active" id="scanner-tab" data-bs-toggle="tab" href="#scanner-content">Scanner</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="manual-tab" data-bs-toggle="tab" href="#manual-content">Recherche manuelle</a>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="scanner-content">
                            <div id="reader"></div>
                            <div class="text-center mt-3">
                                <button id="start-scan" class="btn btn-primary">
                                    <i class="bi bi-camera"></i> Démarrer le scan
                                </button>
                                <button id="stop-scan" class="btn btn-danger" disabled>
                                    <i class="bi bi-stop-circle"></i> Arrêter
                                </button>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="manual-content">
                            <div class="mb-3">
                                <label for="manual-search-type" class="form-label">Rechercher par</label>
                                <select class="form-select" id="manual-search-type">
                                    <option value="marque">Marque</option>
                                    <option value="model">Modèle</option>
                                    <option value="serial">Numéro de série</option>
                                </select>
                            </div>
                            <div class="input-group mb-3">
                                <input type="text" class="form-control" id="manual-search" placeholder="Entrez votre recherche...">
                                <button class="btn btn-primary" type="button" onclick="manualSearch()">
                                    <i class="bi bi-search"></i> Rechercher
                                </button>
                            </div>
                            <div id="manual-search-results" class="mt-3">
                                <!-- Résultats de recherche -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-secondary mt-3" onclick="showView('home')">
                <i class="bi bi-arrow-left"></i> Retour
            </button>
        </div>

        <!-- Vue CVI -->
        <div id="cvi-view" class="view hidden">
            <h2><i class="bi bi-calendar-check"></i> Gestion des CVI</h2>
            
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="input-group">
                                <input type="text" class="form-control" id="cvi-search" placeholder="Rechercher...">
                                <button class="btn btn-outline-secondary" type="button" onclick="filterCVI()">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <select class="form-select" id="cvi-filter" onchange="filterCVI()">
                                <option value="all">Tous les statuts</option>
                                <option value="expired">Expirés</option>
                                <option value="expiring">Bientôt expirés</option>
                                <option value="valid">Valides</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>Marque</th>
                            <th>Modèle</th>
                            <th>Numéro de série</th>
                            <th>Emplacement</th>
                            <th>Date fin CVI</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="cvi-table-body">
                        <!-- Rempli dynamiquement -->
                    </tbody>
                </table>
            </div>
            
            <button class="btn btn-secondary mt-3" onclick="showView('home')">
                <i class="bi bi-arrow-left"></i> Retour
            </button>
        </div>

        <!-- Vue Export/Import -->
        <div id="export-view" class="view hidden">
            <h2><i class="bi bi-cloud-arrow-down"></i> Gestion des sauvegardes</h2>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <i class="bi bi-cloud-arrow-up"></i> Exporter les données
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-primary" onclick="exportData('json')">
                                    <i class="bi bi-filetype-json"></i> Exporter en JSON
                                </button>
                                <button class="btn btn-outline-success" onclick="exportData('excel')">
                                    <i class="bi bi-file-earmark-excel"></i> Exporter en Excel
                                </button>
                                <button class="btn btn-outline-secondary" onclick="exportData('csv')">
                                    <i class="bi bi-filetype-csv"></i> Exporter en CSV
                                </button>
                                <button class="btn btn-outline-danger" onclick="exportData('pdf')">
                                    <i class="bi bi-file-earmark-pdf"></i> Exporter en PDF
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <i class="bi bi-cloud-arrow-down"></i> Importer des données
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="import-type" class="form-label">Type de fichier</label>
                                <select class="form-select" id="import-type">
                                    <option value="json">JSON</option>
                                    <option value="excel">Excel</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="import-file" class="form-label">Fichier à importer</label>
                                <input type="file" class="form-control" id="import-file">
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="merge-data" checked>
                                <label class="form-check-label" for="merge-data">
                                    Fusionner avec les données existantes
                                </label>
                            </div>
                            <button class="btn btn-success w-100" onclick="importData()">
                                <i class="bi bi-upload"></i> Importer
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card mt-4">
                <div class="card-header bg-warning text-dark">
                    <i class="bi bi-exclamation-triangle"></i> Zone dangereuse
                </div>
                <div class="card-body">
                    <p class="text-muted">Ces actions sont irréversibles. Utilisez avec précaution.</p>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-danger" onclick="confirmResetData()">
                            <i class="bi bi-trash"></i> Réinitialiser toutes les données
                        </button>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-secondary mt-3" onclick="showView('home')">
                <i class="bi bi-arrow-left"></i> Retour
            </button>
        </div>

        <!-- Vue Statistiques -->
        <div id="stats-view" class="view hidden">
            <h2><i class="bi bi-graph-up"></i> Statistiques</h2>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>Répartition par catégorie</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="categoryChart" height="300"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>Statut des CVI</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="cviStatusChart" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card mt-4">
                <div class="card-header">
                    <h5>Machines par emplacement</h5>
                </div>
                <div class="card-body">
                    <canvas id="locationChart" height="300"></canvas>
                </div>
            </div>
            
            <button class="btn btn-secondary mt-3" onclick="showView('home')">
                <i class="bi bi-arrow-left"></i> Retour
            </button>
        </div>
    </div>

    <!-- Modal Produit -->
    <div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Fiche Produit</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="product-modal-body">
                    <!-- Rempli dynamiquement -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Fermer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal QR Code -->
    <div class="modal fade" id="qrCodeModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">QR Code</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <div id="qr-code-modal-content"></div>
                    <div class="mt-3">
                        <button class="btn btn-primary" onclick="downloadQRCode()">
                            <i class="bi bi-download"></i> Télécharger
                        </button>
                        <button class="btn btn-secondary" onclick="printQRCode()">
                            <i class="bi bi-printer"></i> Imprimer
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Confirmation -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title">Confirmation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="confirm-modal-body">
                    <!-- Rempli dynamiquement -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-danger" id="confirm-action-btn">Confirmer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay de chargement -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="text-center">
            <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
            <h3 id="loading-text">Chargement en cours...</h3>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <script>
        // Variables globales
        let machines = JSON.parse(localStorage.getItem('machines')) || [];
        let activityLog = JSON.parse(localStorage.getItem('activityLog')) || [];
        let html5QrcodeScanner = null;
        let currentScanIndex = null;
        let currentQRCodeData = null;
        let charts = {};
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // Événements
            document.getElementById('add-machine-form').addEventListener('submit', addMachine);
            document.getElementById('start-scan').addEventListener('click', startScanner);
            document.getElementById('stop-scan').addEventListener('click', stopScanner);
            
            // Initialiser les onglets
            const tabElms = document.querySelectorAll('button[data-bs-toggle="tab"]');
            tabElms.forEach(tabEl => {
                tabEl.addEventListener('shown.bs.tab', function(event) {
                    if (event.target.id === 'scanner-tab') {
                        stopScanner();
                    }
                });
            });
            
            // Charger les données
            updateDashboard();
            showView('home');
        });

        // ==============================================
        // GESTION DES VUES
        // ==============================================
        
        function showView(viewName) {
            document.querySelectorAll('.view').forEach(view => {
                view.classList.add('hidden');
            });
            document.getElementById(`${viewName}-view`).classList.remove('hidden');
            
            // Actions spécifiques à chaque vue
            switch(viewName) {
                case 'home':
                    updateDashboard();
                    break;
                case 'list-machines':
                    updateInventory();
                    break;
                case 'cvi':
                    updateCVIList();
                    break;
                case 'stats':
                    initCharts();
                    break;
                case 'scan':
                    stopScanner();
                    break;
            }
        }
        
        function updateDashboard() {
            document.getElementById('total-machines').textContent = machines.reduce((sum, m) => sum + m.quantite, 0);
            
            // Calculer les CVI expirés et bientôt expirés
            let expired = 0;
            let expiring = 0;
            
            machines.forEach(machine => {
                (machine.unites || []).forEach(unit => {
                    if (unit.etatcvi === 'oui' && unit.dateFinCVI) {
                        const endDate = new Date(unit.dateFinCVI);
                        const today = new Date();
                        const diffTime = endDate - today;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        
                        if (diffDays < 0) {
                            expired++;
                        } else if (diffDays <= 30) {
                            expiring++;
                        }
                    }
                });
            });
            
            document.getElementById('expired-cvi').textContent = expired;
            document.getElementById('expiring-cvi').textContent = expiring;
            
            // Mettre à jour l'activité récente
            updateRecentActivity();
        }
        
        function updateRecentActivity() {
            const tbody = document.getElementById('recent-activity');
            tbody.innerHTML = '';
            
            // Trier par date (du plus récent au plus ancien)
            const sortedActivity = [...activityLog].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Afficher les 5 dernières activités
            sortedActivity.slice(0, 5).forEach(activity => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formatDate(activity.timestamp)}</td>
                    <td>${activity.action}</td>
                    <td>${activity.machine || ''}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function logActivity(action, machineInfo = null) {
            const activity = {
                timestamp: new Date().toISOString(),
                action: action,
                machine: machineInfo ? `${machineInfo.marque} ${machineInfo.model}` : null
            };
            
            activityLog.unshift(activity);
            if (activityLog.length > 50) {
                activityLog = activityLog.slice(0, 50);
            }
            
            localStorage.setItem('activityLog', JSON.stringify(activityLog));
            updateRecentActivity();
        }

        // ==============================================
        // GESTION DES MACHINES
        // ==============================================
        
        function addMachine(e) {
            e.preventDefault();
            showLoading('Ajout de la machine...');
            
            const marque = document.getElementById('marque').value.trim();
            const model = document.getElementById('model').value.trim();
            const quantite = parseInt(document.getElementById('quantite').value);
            const position = document.getElementById('position').value.trim();
            const categorie = document.getElementById('categorie').value;
            const notes = document.getElementById('notes').value.trim();
            
            if (!marque || !model || isNaN(quantite) || quantite < 1 || !position) {
                hideLoading();
                showAlert('Veuillez remplir tous les champs obligatoires', 'danger');
                return;
            }
            
            // Vérifier si le modèle existe déjà
            const existingIndex = machines.findIndex(m => 
                m.marque.toLowerCase() === marque.toLowerCase() && 
                m.model.toLowerCase() === model.toLowerCase()
            );
            
            if (existingIndex !== -1) {
                // Mise à jour de la quantité
                machines[existingIndex].quantite += quantite;
                machines[existingIndex].position = position;
                
                // Créer les unités supplémentaires
                for (let i = 0; i < quantite; i++) {
                    machines[existingIndex].unites.push({
                        numserie: '',
                        etatcvi: 'non',
                        dateFinCVI: null
                    });
                }
                
                logActivity('Quantité mise à jour', machines[existingIndex]);
                showAlert('Quantité mise à jour pour ce modèle', 'success');
            } else {
                // Nouvelle machine
                const newMachine = {
                    marque: marque,
                    model: model,
                    quantite: quantite,
                    position: position,
                    categorie: categorie,
                    notes: notes,
                    unites: [],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                // Créer les unités
                for (let i = 0; i < quantite; i++) {
                    newMachine.unites.push({
                        numserie: '',
                        etatcvi: 'non',
                        dateFinCVI: null
                    });
                }
                
                machines.push(newMachine);
                logActivity('Nouvelle machine ajoutée', newMachine);
                showAlert('Nouveau modèle ajouté', 'success');
            }
            
            saveMachines();
            document.getElementById('add-machine-form').reset();
            hideLoading();
            showView('list-machines');
        }
        
        function updateInventory() {
            const tbody = document.getElementById('machines-table-body');
            tbody.innerHTML = '';
            
            if (machines.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">Aucune machine enregistrée</td></tr>';
                return;
            }
            
            machines.forEach((machine, index) => {
                const tr = document.createElement('tr');
                const qr = qrcode(0, 'L');
                qr.addData(JSON.stringify({
                    id: index,
                    marque: machine.marque,
                    model: machine.model,
                    position: machine.position
                }));
                qr.make();
                
                // Compter les unités avec CVI
                const cviCount = (machine.unites || []).filter(u => u.etatcvi === 'oui').length;
                
                tr.innerHTML = `
                    <td>${machine.marque}</td>
                    <td>${machine.model}</td>
                    <td>${machine.categorie || 'Non spécifié'}</td>
                    <td>${machine.quantite} ${cviCount > 0 ? `(${cviCount} avec CVI)` : ''}</td>
                    <td>${machine.position}</td>
                    <td>
                        <button class="btn btn-sm btn-primary me-1" onclick="showProductModal(${index})" title="Modifier">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="confirmDeleteMachine(${index})" title="Supprimer">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                    <td class="text-center">
                        <div class="qr-code-img" onclick="showQRCodeModal(${index})">
                            ${qr.createImgTag(2)}
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function filterMachines() {
            const searchTerm = document.getElementById('inventory-search').value.toLowerCase();
            const filterValue = document.getElementById('inventory-filter').value;
            
            const rows = document.querySelectorAll('#machines-table-body tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const marque = cells[0].textContent.toLowerCase();
                const model = cells[1].textContent.toLowerCase();
                const categorie = cells[2].textContent.toLowerCase();
                const position = cells[4].textContent.toLowerCase();
                
                const matchesSearch = marque.includes(searchTerm) || model.includes(searchTerm) || position.includes(searchTerm);
                const matchesFilter = filterValue === 'all' || categorie.includes(filterValue.toLowerCase());
                
                row.style.display = matchesSearch && matchesFilter ? '' : 'none';
            });
        }
        
        function showProductModal(index) {
            const machine = machines[index];
            currentScanIndex = index;
            
            const modalBody = document.getElementById('product-modal-body');
            let unitCards = '';
            
            (machine.unites || []).forEach((unit, i) => {
                const cviStatus = getCVIStatus(unit.dateFinCVI);
                let statusBadge = '';
                
                if (unit.etatcvi === 'oui') {
                    let badgeClass = 'bg-secondary';
                    if (cviStatus === 'expired') badgeClass = 'bg-danger';
                    if (cviStatus === 'expiring') badgeClass = 'bg-warning';
                    if (cviStatus === 'valid') badgeClass = 'bg-success';
                    
                    statusBadge = `<span class="badge ${badgeClass}">CVI: ${formatDate(unit.dateFinCVI)}</span>`;
                }
                
                unitCards += `
                    <div class="unit-card">
                        ${statusBadge}
                        <h6>Unité ${i + 1}</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-2">
                                    <label class="form-label">Numéro de série</label>
                                    <input type="text" class="form-control unit-serial" data-index="${i}" value="${unit.numserie || ''}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-2">
                                    <label class="form-label">CVI</label>
                                    <select class="form-select unit-cvi" data-index="${i}">
                                        <option value="non" ${unit.etatcvi === 'non' ? 'selected' : ''}>Non</option>
                                        <option value="oui" ${unit.etatcvi === 'oui' ? 'selected' : ''}>Oui</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row unit-cvi-date-row" style="${unit.etatcvi === 'oui' ? '' : 'display: none;'}">
                            <div class="col-md-12">
                                <div class="mb-2">
                                    <label class="form-label">Date fin CVI</label>
                                    <input type="date" class="form-control unit-cvi-date" data-index="${i}" value="${unit.dateFinCVI || ''}">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Marque *</label>
                            <input type="text" class="form-control" id="modal-marque" value="${machine.marque}" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Modèle *</label>
                            <input type="text" class="form-control" id="modal-model" value="${machine.model}" required>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Quantité *</label>
                            <input type="number" class="form-control" id="modal-quantity" value="${machine.quantite}" min="1" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Catégorie</label>
                            <select class="form-select" id="modal-category">
                                <option value="Ordinateur" ${machine.categorie === 'Ordinateur' ? 'selected' : ''}>Ordinateur</option>
                                <option value="Serveur" ${machine.categorie === 'Serveur' ? 'selected' : ''}>Serveur</option>
                                <option value="Imprimante" ${machine.categorie === 'Imprimante' ? 'selected' : ''}>Imprimante</option>
                                <option value="Réseau" ${machine.categorie === 'Réseau' ? 'selected' : ''}>Équipement réseau</option>
                                <option value="Autre" ${machine.categorie === 'Autre' ? 'selected' : ''}>Autre</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Emplacement *</label>
                            <input type="text" class="form-control" id="modal-position" value="${machine.position}" required>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Notes</label>
                    <textarea class="form-control" id="modal-notes" rows="2">${machine.notes || ''}</textarea>
                </div>
                
                <h5 class="mt-4">Gestion des unités</h5>
                <div id="unit-cards-container">
                    ${unitCards}
                </div>
                
                <div class="d-flex justify-content-between mt-4">
                    <div>
                        <button type="button" class="btn btn-success" onclick="updateProduct()">
                            <i class="bi bi-save"></i> Enregistrer
                        </button>
                        <button type="button" class="btn btn-outline-primary" onclick="addUnit()">
                            <i class="bi bi-plus-circle"></i> Ajouter une unité
                        </button>
                    </div>
                    <button type="button" class="btn btn-danger" onclick="confirmDeleteMachine(${index})">
                        <i class="bi bi-trash"></i> Supprimer
                    </button>
                </div>
            `;
            
            // Gestion des événements pour les unités
            document.querySelectorAll('.unit-cvi').forEach(select => {
                select.addEventListener('change', function() {
                    const unitIndex = this.getAttribute('data-index');
                    const dateRow = document.querySelector(`.unit-cvi-date-row[data-index="${unitIndex}"]`);
                    if (this.value === 'oui') {
                        dateRow.style.display = '';
                    } else {
                        dateRow.style.display = 'none';
                    }
                });
            });
            
            const modal = new bootstrap.Modal(document.getElementById('productModal'));
            modal.show();
        }
        
        function addUnit() {
            const index = currentScanIndex;
            const quantityInput = document.getElementById('modal-quantity');
            const currentQuantity = parseInt(quantityInput.value);
            
            machines[index].quantite = currentQuantity + 1;
            machines[index].unites.push({
                numserie: '',
                etatcvi: 'non',
                dateFinCVI: null
            });
            
            quantityInput.value = currentQuantity + 1;
            showProductModal(index);
        }
        
        function updateProduct() {
            const index = currentScanIndex;
            const machine = machines[index];
            
            const marque = document.getElementById('modal-marque').value.trim();
            const model = document.getElementById('modal-model').value.trim();
            const quantite = parseInt(document.getElementById('modal-quantity').value);
            const position = document.getElementById('modal-position').value.trim();
            const categorie = document.getElementById('modal-category').value;
            const notes = document.getElementById('modal-notes').value.trim();
            
            if (!marque || !model || isNaN(quantite) || quantite < 1 || !position) {
                showAlert('Veuillez remplir tous les champs obligatoires', 'danger');
                return;
            }
            
            // Mettre à jour les informations de base
            machine.marque = marque;
            machine.model = model;
            machine.quantite = quantite;
            machine.position = position;
            machine.categorie = categorie;
            machine.notes = notes;
            machine.updatedAt = new Date().toISOString();
            
            // Mettre à jour les unités
            document.querySelectorAll('.unit-serial').forEach(input => {
                const unitIndex = input.getAttribute('data-index');
                machine.unites[unitIndex].numserie = input.value.trim();
            });
            
            document.querySelectorAll('.unit-cvi').forEach(select => {
                const unitIndex = select.getAttribute('data-index');
                machine.unites[unitIndex].etatcvi = select.value;
            });
            
            document.querySelectorAll('.unit-cvi-date').forEach(input => {
                const unitIndex = input.getAttribute('data-index');
                if (machine.unites[unitIndex].etatcvi === 'oui') {
                    machine.unites[unitIndex].dateFinCVI = input.value;
                } else {
                    machine.unites[unitIndex].dateFinCVI = null;
                }
            });
            
            // Ajuster le nombre d'unités si la quantité a diminué
            if (machine.unites.length > quantite) {
                machine.unites = machine.unites.slice(0, quantite);
            }
            
            // Ajouter des unités si la quantité a augmenté
            while (machine.unites.length < quantite) {
                machine.unites.push({
                    numserie: '',
                    etatcvi: 'non',
                    dateFinCVI: null
                });
            }
            
            saveMachines();
            updateInventory();
            updateCVIList();
            logActivity('Machine modifiée', machine);
            showAlert('Produit mis à jour', 'success');
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
            modal.hide();
        }
        
        function confirmDeleteMachine(index) {
            const machine = machines[index];
            const confirmBody = document.getElementById('confirm-modal-body');
            confirmBody.innerHTML = `
                <p>Êtes-vous sûr de vouloir supprimer cette machine ?</p>
                <p><strong>${machine.marque} ${machine.model}</strong> (${machine.quantite} unité(s))</p>
                <p class="text-danger">Cette action est irréversible !</p>
            `;
            
            const confirmBtn = document.getElementById('confirm-action-btn');
            confirmBtn.onclick = function() {
                deleteMachine(index);
                bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
            };
            
            const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
            modal.show();
        }
        
        function deleteMachine(index) {
            const deletedMachine = machines.splice(index, 1)[0];
            saveMachines();
            updateInventory();
            updateCVIList();
            logActivity('Machine supprimée', deletedMachine);
            showAlert('Machine supprimée', 'success');
        }
        
        // ==============================================
        // GESTION DES CVI
        // ==============================================
        
        function updateCVIList() {
            const tbody = document.getElementById('cvi-table-body');
            tbody.innerHTML = '';
            
            let hasCVI = false;
            
            machines.forEach((machine, machineIndex) => {
                (machine.unites || []).forEach((unit, unitIndex) => {
                    if (unit.etatcvi === 'oui' && unit.numserie) {
                        hasCVI = true;
                        const cviStatus = getCVIStatus(unit.dateFinCVI);
                        let statusText = '';
                        let rowClass = '';
                        
                        if (cviStatus === 'expired') {
                            statusText = 'Expiré';
                            rowClass = 'cvi-expired';
                        } else if (cviStatus === 'expiring') {
                            statusText = 'Bientôt expiré';
                            rowClass = 'cvi-soon';
                        } else {
                            statusText = 'Valide';
                        }
                        
                        const tr = document.createElement('tr');
                        tr.className = rowClass;
                        tr.innerHTML = `
                            <td>${machine.marque}</td>
                            <td>${machine.model}</td>
                            <td>${unit.numserie}</td>
                            <td>${machine.position}</td>
                            <td>${formatDate(unit.dateFinCVI)}</td>
                            <td>${statusText}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="showUnitModal(${machineIndex}, ${unitIndex})">
                                    <i class="bi bi-pencil"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    }
                });
            });
            
            if (!hasCVI) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">Aucune machine avec CVI enregistrée</td></tr>';
            }
            
            updateDashboard();
        }
        
        function showUnitModal(machineIndex, unitIndex) {
            const machine = machines[machineIndex];
            const unit = machine.unites[unitIndex];
            
            const modalBody = document.getElementById('product-modal-body');
            modalBody.innerHTML = `
                <h4>${machine.marque} ${machine.model}</h4>
                <p class="text-muted">${machine.position}</p>
                
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Numéro de série *</label>
                            <input type="text" class="form-control" id="unit-serial" value="${unit.numserie || ''}" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">CVI</label>
                            <select class="form-select" id="unit-cvi">
                                <option value="non" ${unit.etatcvi === 'non' ? 'selected' : ''}>Non</option>
                                <option value="oui" ${unit.etatcvi === 'oui' ? 'selected' : ''}>Oui</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3" id="unit-cvi-date-container" style="${unit.etatcvi === 'oui' ? '' : 'display: none;'}">
                    <label class="form-label">Date fin CVI</label>
                    <input type="date" class="form-control" id="unit-cvi-date" value="${unit.dateFinCVI || ''}">
                </div>
                
                <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-primary" onclick="updateUnit(${machineIndex}, ${unitIndex})">
                        <i class="bi bi-save"></i> Enregistrer
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Fermer
                    </button>
                </div>
            `;
            
            document.getElementById('unit-cvi').addEventListener('change', function() {
                document.getElementById('unit-cvi-date-container').style.display = 
                    this.value === 'oui' ? 'block' : 'none';
            });
            
            const modal = new bootstrap.Modal(document.getElementById('productModal'));
            modal.show();
        }
        
        function updateUnit(machineIndex, unitIndex) {
            const machine = machines[machineIndex];
            const unit = machine.unites[unitIndex];
            
            const numserie = document.getElementById('unit-serial').value.trim();
            const etatcvi = document.getElementById('unit-cvi').value;
            const dateFinCVI = etatcvi === 'oui' ? document.getElementById('unit-cvi-date').value : null;
            
            if (!numserie) {
                showAlert('Le numéro de série est obligatoire', 'danger');
                return;
            }
            
            unit.numserie = numserie;
            unit.etatcvi = etatcvi;
            unit.dateFinCVI = dateFinCVI;
            
            machine.updatedAt = new Date().toISOString();
            saveMachines();
            updateCVIList();
            logActivity('Unité mise à jour', machine);
            showAlert('Unité mise à jour', 'success');
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
            modal.hide();
        }
        
        function filterCVI() {
            const searchTerm = document.getElementById('cvi-search').value.toLowerCase();
            const filterValue = document.getElementById('cvi-filter').value;
            
            const rows = document.querySelectorAll('#cvi-table-body tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const marque = cells[0].textContent.toLowerCase();
                const model = cells[1].textContent.toLowerCase();
                const serial = cells[2].textContent.toLowerCase();
                const position = cells[3].textContent.toLowerCase();
                const status = cells[5].textContent.toLowerCase();
                
                const matchesSearch = marque.includes(searchTerm) || model.includes(searchTerm) || 
                                     serial.includes(searchTerm) || position.includes(searchTerm);
                
                let matchesFilter = true;
                if (filterValue === 'expired') {
                    matchesFilter = row.classList.contains('cvi-expired');
                } else if (filterValue === 'expiring') {
                    matchesFilter = row.classList.contains('cvi-soon');
                } else if (filterValue === 'valid') {
                    matchesFilter = !row.classList.contains('cvi-expired') && 
                                    !row.classList.contains('cvi-soon');
                }
                
                row.style.display = matchesSearch && matchesFilter ? '' : 'none';
            });
        }
        
        function getCVIStatus(endDate) {
            if (!endDate) return 'none';
            
            const end = new Date(endDate);
            const today = new Date();
            const diffTime = end - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) return 'expired';
            if (diffDays <= 30) return 'expiring';
            return 'valid';
        }
        
        // ==============================================
        // GESTION DES QR CODES
        // ==============================================
        
        function showQRCodeModal(index) {
            const machine = machines[index];
            currentQRCodeData = {
                id: index,
                marque: machine.marque,
                model: machine.model,
                position: machine.position,
                quantite: machine.quantite,
                categorie: machine.categorie
            };
            
            const qr = qrcode(0, 'L');
            qr.addData(JSON.stringify(currentQRCodeData));
            qr.make();
            
            const modalContent = document.getElementById('qr-code-modal-content');
            modalContent.innerHTML = `
                <h5>${machine.marque} ${machine.model}</h5>
                <p class="text-muted">${machine.position}</p>
                ${qr.createImgTag(6)}
                <p class="mt-2"><small>ID: ${index}</small></p>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('qrCodeModal'));
            modal.show();
        }
        
        function downloadQRCode() {
            if (!currentQRCodeData) return;
            
            const canvas = document.querySelector('#qr-code-modal-content canvas');
            const link = document.createElement('a');
            link.download = `QRCode_${currentQRCodeData.marque}_${currentQRCodeData.model}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }
        
        function printQRCode() {
            const printWindow = window.open('', '_blank');
            const machine = machines[currentQRCodeData.id];
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>QR Code - ${machine.marque} ${machine.model}</title>
                    <style>
                        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
                        h1 { margin-bottom: 5px; }
                        .subtitle { color: #666; margin-bottom: 20px; }
                        .qr-code { margin: 20px auto; }
                        .info { margin-top: 20px; text-align: left; max-width: 300px; margin-left: auto; margin-right: auto; }
                        .info p { margin: 5px 0; }
                        @media print {
                            @page { size: auto; margin: 5mm; }
                        }
                    </style>
                </head>
                <body>
                    <h1>${machine.marque} ${machine.model}</h1>
                    <div class="subtitle">${machine.position}</div>
                    <div class="qr-code">${document.querySelector('#qr-code-modal-content').innerHTML}</div>
                    <div class="info">
                        <p><strong>ID:</strong> ${currentQRCodeData.id}</p>
                        <p><strong>Quantité:</strong> ${machine.quantite}</p>
                        <p><strong>Catégorie:</strong> ${machine.categorie || 'Non spécifié'}</p>
                        <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                    </div>
                    <script>
                        window.onload = function() {
                            setTimeout(function() {
                                window.print();
                                window.close();
                            }, 200);
                        };
                    </script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }
        
        // ==============================================
        // SCANNER QR CODE
        // ==============================================
        
        function startScanner() {
            document.getElementById('start-scan').disabled = true;
            document.getElementById('stop-scan').disabled = false;
            
            const html5QrCode = new Html5Qrcode("reader");
            
            Html5Qrcode.getCameras().then(cameras => {
                if (cameras && cameras.length > 0) {
                    const cameraId = cameras[0]?.id;
                    
                    html5QrCode.start(
                        cameraId,
                        { 
                            fps: 10, 
                            qrbox: { width: 250, height: 250 },
                            aspectRatio: 1.0
                        },
                        onScanSuccess,
                        errorMessage => {
                            if (errorMessage !== "NotFoundException: No MultiFormat Readers were able to detect the code.") {
                                console.warn("Erreur scan :", errorMessage);
                            }
                        }
                    ).then(() => {
                        html5QrcodeScanner = html5QrCode;
                    }).catch(err => {
                        console.error("Erreur démarrage scanner", err);
                        showAlert("Erreur démarrage scanner : " + err, "danger");
                        resetScannerButtons();
                    });
                } else {
                    showAlert("Aucune caméra détectée", "danger");
                    resetScannerButtons();
                }
            }).catch(err => {
                console.error("Erreur récupération caméra", err);
                showAlert("Erreur accès caméra : " + err, "danger");
                resetScannerButtons();
            });
        }
        
        function stopScanner() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    html5QrcodeScanner.clear();
                    resetScannerButtons();
                }).catch(error => {
                    console.error("Erreur arrêt scanner:", error);
                    resetScannerButtons();
                });
            } else {
                resetScannerButtons();
            }
        }
        
        function resetScannerButtons() {
            document.getElementById('start-scan').disabled = false;
            document.getElementById('stop-scan').disabled = true;
            html5QrcodeScanner = null;
        }
        
        function onScanSuccess(decodedText) {
            stopScanner();
            
            try {
                const data = JSON.parse(decodedText);
                
                if (data.id !== undefined && machines[data.id]) {
                    currentScanIndex = data.id;
                    showProductModal(data.id);
                    return;
                }
            } catch (e) {
                console.log("Le QR code n'est pas au format JSON, tentative d'analyse simple");
            }
            
            // Fallback pour les anciens QR codes
            const parts = decodedText.split('|');
            if (parts.length >= 2) {
                const [marque, model] = parts.map(p => p.toLowerCase());
                
                const foundIndex = machines.findIndex(m =>
                    m.marque.toLowerCase() === marque && 
                    m.model.toLowerCase() === model
                );
                
                if (foundIndex !== -1) {
                    showProductModal(foundIndex);
                    return;
                }
            }
            
            showAlert('Produit non trouvé dans l\'inventaire', 'danger');
        }
        
        function manualSearch() {
            const searchType = document.getElementById('manual-search-type').value;
            const searchTerm = document.getElementById('manual-search').value.trim().toLowerCase();
            
            if (!searchTerm) {
                showAlert('Veuillez entrer un terme de recherche', 'warning');
                return;
            }
            
            const resultsContainer = document.getElementById('manual-search-results');
            resultsContainer.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div></div>';
            
            // Simuler un délai pour l'UI (peut être retiré en production)
            setTimeout(() => {
                let results = [];
                
                if (searchType === 'serial') {
                    // Recherche par numéro de série dans les unités
                    machines.forEach((machine, machineIndex) => {
                        (machine.unites || []).forEach((unit, unitIndex) => {
                            if (unit.numserie && unit.numserie.toLowerCase().includes(searchTerm)) {
                                results.push({
                                    machineIndex,
                                    unitIndex,
                                    machine,
                                    unit
                                });
                            }
                        });
                    });
                } else {
                    // Recherche par marque ou modèle
                    results = machines
                        .map((machine, index) => ({ machine, index }))
                        .filter(item => {
                            if (searchType === 'marque') {
                                return item.machine.marque.toLowerCase().includes(searchTerm);
                            } else {
                                return item.machine.model.toLowerCase().includes(searchTerm);
                            }
                        });
                }
                
                displaySearchResults(results, searchType);
            }, 500);
        }
        
        function displaySearchResults(results, searchType) {
            const resultsContainer = document.getElementById('manual-search-results');
            
            if (results.length === 0) {
                resultsContainer.innerHTML = '<div class="alert alert-warning">Aucun résultat trouvé</div>';
                return;
            }
            
            let html = '<div class="list-group">';
            
            if (searchType === 'serial') {
                // Affichage des résultats par numéro de série
                results.forEach(result => {
                    const cviStatus = result.unit.etatcvi === 'oui' ? 
                        `<span class="badge bg-${getCVIStatus(result.unit.dateFinCVI) === 'expired' ? 'danger' : 'success'}">CVI</span>` : '';
                    
                    html += `
                        <a href="#" class="list-group-item list-group-item-action" 
                           onclick="showUnitModal(${result.machineIndex}, ${result.unitIndex})">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">${result.machine.marque} ${result.machine.model}</h5>
                                ${cviStatus}
                            </div>
                            <p class="mb-1">Numéro de série: ${result.unit.numserie}</p>
                            <small>${result.machine.position}</small>
                        </a>
                    `;
                });
            } else {
                // Affichage des résultats par marque/modèle
                results.forEach(result => {
                    const cviCount = (result.machine.unites || []).filter(u => u.etatcvi === 'oui').length;
                    const cviBadge = cviCount > 0 ? 
                        `<span class="badge bg-success">${cviCount} CVI</span>` : '';
                    
                    html += `
                        <a href="#" class="list-group-item list-group-item-action" 
                           onclick="showProductModal(${result.index})">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">${result.machine.marque} ${result.machine.model}</h5>
                                ${cviBadge}
                            </div>
                            <p class="mb-1">Quantité: ${result.machine.quantite}</p>
                            <small>${result.machine.position}</small>
                        </a>
                    `;
                });
            }
            
            html += '</div>';
            resultsContainer.innerHTML = html;
        }
        
        // ==============================================
        // EXPORT/IMPORT DE DONNÉES
        // ==============================================
        
        function exportData(type) {
            showLoading('Préparation de l\'export...');
            
            setTimeout(() => {
                try {
                    switch(type) {
                        case 'json':
                            exportToJSON();
                            break;
                        case 'excel':
                            exportToExcel();
                            break;
                        case 'csv':
                            exportToCSV();
                            break;
                        case 'pdf':
                            exportToPDF();
                            break;
                    }
                } catch (error) {
                    console.error("Erreur lors de l'export:", error);
                    showAlert("Erreur lors de l'export: " + error.message, "danger");
                } finally {
                    hideLoading();
                }
            }, 100);
        }
        
        function exportToJSON() {
            const data = {
                machines: machines,
                activityLog: activityLog,
                exportedAt: new Date().toISOString(),
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `machines_export_${formatDate(new Date(), 'file')}.json`;
            a.click();
            
            logActivity('Export JSON effectué');
            showAlert('Export JSON réussi', 'success');
        }
        
        function exportToExcel() {
            // Préparer les données pour Excel
            const excelData = machines.map(machine => {
                const cviUnits = (machine.unites || []).filter(u => u.etatcvi === 'oui').length;
                
                return {
                    'Marque': machine.marque,
                    'Modèle': machine.model,
                    'Catégorie': machine.categorie,
                    'Quantité': machine.quantite,
                    'Unités avec CVI': cviUnits,
                    'Emplacement': machine.position,
                    'Notes': machine.notes,
                    'Date création': formatDate(machine.createdAt),
                    'Dernière modification': formatDate(machine.updatedAt)
                };
            });
            
            const ws = XLSX.utils.json_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Machines");
            
            // Ajouter une feuille pour les CVI
            const cviData = [];
            machines.forEach(machine => {
                (machine.unites || []).forEach(unit => {
                    if (unit.etatcvi === 'oui') {
                        cviData.push({
                            'Marque': machine.marque,
                            'Modèle': machine.model,
                            'Numéro de série': unit.numserie,
                            'Emplacement': machine.position,
                            'Date fin CVI': formatDate(unit.dateFinCVI),
                            'Statut': getCVIStatus(unit.dateFinCVI) === 'expired' ? 'Expiré' : 
                                     (getCVIStatus(unit.dateFinCVI) === 'expiring' ? 'Bientôt expiré' : 'Valide')
                        });
                    }
                });
            });
            
            if (cviData.length > 0) {
                const wsCVI = XLSX.utils.json_to_sheet(cviData);
                XLSX.utils.book_append_sheet(wb, wsCVI, "CVI");
            }
            
            // Générer le fichier Excel
            const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
            const blob = new Blob([wbout], { type: "application/octet-stream" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `machines_export_${formatDate(new Date(), 'file')}.xlsx`;
            a.click();
            
            logActivity('Export Excel effectué');
            showAlert('Export Excel réussi', 'success');
        }
        
        function exportToCSV() {
            // Préparer les données pour CSV
            const csvData = machines.map(machine => {
                const cviUnits = (machine.unites || []).filter(u => u.etatcvi === 'oui').length;
                
                return [
                    machine.marque,
                    machine.model,
                    machine.categorie || '',
                    machine.quantite,
                    cviUnits,
                    machine.position,
                    machine.notes ? machine.notes.replace(/"/g, '""') : '',
                    formatDate(machine.createdAt),
                    formatDate(machine.updatedAt)
                ];
            });
            
            // Entête CSV
            const headers = [
                'Marque', 'Modèle', 'Catégorie', 'Quantité', 'Unités avec CVI', 
                'Emplacement', 'Notes', 'Date création', 'Dernière modification'
            ];
            
            // Convertir en chaîne CSV
            let csvContent = headers.join(';') + '\r\n';
            csvData.forEach(row => {
                csvContent += row.map(field => `"${field}"`).join(';') + '\r\n';
            });
            
            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `machines_export_${formatDate(new Date(), 'file')}.csv`;
            a.click();
            
            logActivity('Export CSV effectué');
            showAlert('Export CSV réussi', 'success');
        }
        
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Titre du document
            doc.setFontSize(18);
            doc.text('Inventaire des Machines', 105, 15, { align: 'center' });
            doc.setFontSize(12);
            doc.text(`Date d'export: ${formatDate(new Date())}`, 105, 22, { align: 'center' });
            
            // Tableau des machines
            const columns = [
                { title: "Marque", dataKey: "marque" },
                { title: "Modèle", dataKey: "model" },
                { title: "Catégorie", dataKey: "categorie" },
                { title: "Quantité", dataKey: "quantite" },
                { title: "Emplacement", dataKey: "position" }
            ];
            
            const data = machines.map(machine => ({
                marque: machine.marque,
                model: machine.model,
                categorie: machine.categorie || 'Non spécifié',
                quantite: machine.quantite,
                position: machine.position
            }));
            
            doc.autoTable({
                columns: columns,
                body: data,
                startY: 30,
                styles: { fontSize: 9 },
                headStyles: { fillColor: [41, 128, 185], textColor: 255 },
                alternateRowStyles: { fillColor: [240, 240, 240] }
            });
            
            // Ajouter une page pour les CVI si nécessaire
            const cviData = [];
            machines.forEach(machine => {
                (machine.unites || []).forEach(unit => {
                    if (unit.etatcvi === 'oui') {
                        cviData.push({
                            marque: machine.marque,
                            model: machine.model,
                            numserie: unit.numserie,
                            position: machine.position,
                            dateFinCVI: formatDate(unit.dateFinCVI),
                            statut: getCVIStatus(unit.dateFinCVI) === 'expired' ? 'Expiré'